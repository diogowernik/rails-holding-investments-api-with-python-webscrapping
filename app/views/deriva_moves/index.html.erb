<%= form_tag deriva_moves_path, method: :get, enforce_utf8: false do %>
    <div class="row">
        <div class="col-md-2 mt-4 ">
            <%= select_tag :por_carteira, options_for_select(Carteira.all.collect {|t| [t.nome, t.id]}, selected: params[:por_carteira]), prompt: 'Carteira', class: 'form-control' %>
        </div>
        <div class="col-md-2 mt-4 ">
            <%= select_tag :por_estado, options_for_select(Estado.all.collect {|t| [t.status, t.id]}, selected: params[:por_estado]), prompt: 'Estado', class: 'form-control' %>
        </div>
        <div class="col-md-2 mt-4 ">
            <%= select_tag :por_corretora, options_for_select(Corretora.all.collect {|t| [t.nome, t.id]}, selected: params[:por_corretora]), prompt: 'Corretora', class: 'form-control' %>
        </div>
        <div class="col-md-2 mt-4 ">
            <%= select_tag :por_ativo, options_for_select(Ativo.where(:tipo_id => 3).all.collect {|t| [t.ticker, t.id]}, selected: params[:por_ativo]), prompt: 'Ativo', class: 'form-control' %>
        </div>
        <div class="col-md-2 mt-4 ">
            <%= select_tag :por_deriva_tipo, options_for_select(DerivaTipo.all.collect {|t| [t.tipo, t.id]}, selected: params[:por_deriva_tipo]), prompt: 'Tipo de Derivativo', class: 'form-control' %>
        </div>
        <!--<div class="col-md-2 mt-4 ">-->
            <%#= select_tag :por_derivativo, options_for_select(Derivativo.all.collect {|t| [t.codigo, t.id]}, selected: params[:por_derivativo]), prompt: 'Derivativo', class: 'form-control' %>
        <!--</div>-->
        <div class="col-md-2 mt-4 ">
            <%= select_tag :por_vencimento, options_for_select(Vencimento.all.collect {|t| [t.data.strftime("%d/%m/%Y"), t.id]}, selected: params[:por_vencimento]), prompt: 'Vencimento', class: 'form-control' %>
        </div>
        
        <!--Como colocar mais informações no options_for_select-->
        <div class="col-md-2 mt-2 mb-4 ">
            <%= select_tag :por_investimento, options_for_select(Investimento.all.collect {|t| [t.ativo.ticker, t.id]}, selected: params[:por_investimento]), prompt: 'Investimento', class: 'form-control' %>
        </div>
        <div class="col-md-2 mt-2 mb-4 ">
            <%= submit_tag 'Filtrar', class: 'btn btn-default', name: nil %>
        </div>
    </div>
<% end %> 
<div class="float-right"><%= link_to new_deriva_move_path do %>
	<button class="btn btn-outline-success">
		<em class="fa fa-plus-circle"></em> &nbsp; Nova movimentação (Derivativos)
	</button><% end %>
</div>
<h3 class="h3-custom" id="minhas-paginas">
	<em class="fa fa-usd text-success"></em> &nbsp; Movimentação dos derivativos
</h3>
<div class="table-responsive">
	<table class="table table-striped table-bordered table-hover" id="DerivaMoveTable">
          <thead>
            <tr class="header">
              <!--<th>Invest</th>-->
              <th style="width: 140px;"> Derivativo</br>
              <input type="text" id="DerivaTivo" onkeyup="DerivaMoveTivoFunction()" placeholder="Derivativo.." class="form-control mt-1">
              </th>
              <th style="width: 140px;">Status </br> 
              <input type="text" id="DerivaStatus" onkeyup="DerivaMoveStatusFunction()" placeholder="Status.." class="form-control mt-1">
              </th>
              <th>Corretora</th>
              <!--<th>Carteira</th>-->
              <th>Tipo</th>
              <th>Vencimento</th>
              <th>Premio</th>
              <th>Quant</th>
              <th>Strike</th>
              <th>Strike Total</th>
              <th>Resultado</th>
              <th colspan="2"></th>
            </tr>
          </thead>
        
          <tbody>
            <% @deriva_moves.order("created_at desc").each do |dm| %>
            <tr>
                <!--<td>-->
                <!--    <#%= dm.investimento.carteira.nome %>  <%#= dm.investimento.corretora.nome %>  <%#= dm.investimento.ativo.ticker %> </br>-->
                    <!--Tem que ser igual a de cima com a de baixo-->
                <!--    <%#= dm.carteira.nome %>  <%#= dm.corretora.nome %>  <%#= dm.derivativo.ativo.ticker %>-->
                <!--</td>-->
                
                <td><%= dm.codigo %></td>
                <td><%= dm.estado.status %></td>
                <!--<td><%#= dm.carteira.nome %></td>-->
                <td><%= dm.corretora.nome %></td>
                <td><%= dm.deriva_tipo.tipo %></td>
                <td><%= dm.vencimento.data.strftime("%d/%m/%Y") %></td>
                <td>R$ <%= number_to_currency(dm.valor, unit: "R$ ", separator: ",", delimiter: ".", strip_insignificant_zeros: true) %></td>
                <td><%= dm.quantidade %></td>
                <td>
                <% if dm.strike.present? %>
                  <%= number_to_currency(dm.strike, unit: "R$ ", separator: ",", delimiter: ".", strip_insignificant_zeros: true)  %>
                <% end %>
                </td>
                <td>
                <% if dm.strike_total.present? %>
                  <%= number_to_currency(dm.strike_total, unit: "R$ ", separator: ",", delimiter: ".", strip_insignificant_zeros: true)  %>
                <% end %>
                </td>
                <td style="width: 145px;">
                    <span class="text-primary"><%= number_to_currency(resultado_aberta(dm), unit: "R$ ", separator: ",", delimiter: ".", strip_insignificant_zeros: true) %></span>
                    <span class="text-primary"><%= number_to_currency(resultado_po(dm), unit: "R$ ", separator: ",", delimiter: ".", strip_insignificant_zeros: true) %></span>
                    <span class="text-primary"><% if dm.strike.present? %><%= number_to_currency(resultado_exercicio(dm), unit: "R$ ", separator: ",", delimiter: ".", strip_insignificant_zeros: true) %><% end %></span>
                    <span class="text-<%= cor_resultado_recompra(dm) %>"><%= number_to_currency(resultado_recompra(dm), unit: "R$ ", separator: ",", delimiter: ".", strip_insignificant_zeros: true) %></span>
                    
                </td>
                <td><%= link_to 'Edit', edit_deriva_move_path(dm) %></td>
                <td><%= link_to 'Destroy', dm, method: :delete, data: { confirm: 'Are you sure?' } %></td>
                
              </tr>
            <% end %>
          </tbody>
    </table>
</div>

<div class="row mt-3 ml-2">
    <p>
      Resultado lucro: 
          <span class="text-primary">
               <b>
                   <%= number_to_currency(@deriva_moves.sum(:resultado), unit: "R$ ", separator: ",", delimiter: ".", strip_insignificant_zeros: true) %>
                </b>
         </span>
     </p>


    
</div>
<div class="row mt-3 ml-2">
     <p>
      
          Garantias necessárias em caso de PUTs: 
          
          <span class="text-primary">
              <b>
               <%= number_to_currency(@deriva_moves.sum(:strike_total), unit: "R$ ", separator: ",", delimiter: ".", strip_insignificant_zeros: true) %>
               </b>
          </span>
            
     </p>

    
</div>

<!--Funcoes de filtro-->

<script>
function DerivaMoveStatusFunction() {
  var input, filter, table, tr, td, i, txtValue;
  input = document.getElementById("DerivaStatus");
  filter = input.value.toUpperCase();
  table = document.getElementById("DerivaMoveTable");
  tr = table.getElementsByTagName("tr");
  for (i = 0; i < tr.length; i++) {
    td = tr[i].getElementsByTagName("td")[1];
    if (td) {
      txtValue = td.textContent || td.innerText;
      if (txtValue.toUpperCase().indexOf(filter) > -1) {
        tr[i].style.display = "";
      } else {
        tr[i].style.display = "none";
      }
    }       
  }
}

function DerivaMoveTivoFunction() {
  var input, filter, table, tr, td, i, txtValue;
  input = document.getElementById("DerivaTivo");
  filter = input.value.toUpperCase();
  table = document.getElementById("DerivaMoveTable");
  tr = table.getElementsByTagName("tr");
  for (i = 0; i < tr.length; i++) {
    td = tr[i].getElementsByTagName("td")[0];
    if (td) {
      txtValue = td.textContent || td.innerText;
      if (txtValue.toUpperCase().indexOf(filter) > -1) {
        tr[i].style.display = "";
      } else {
        tr[i].style.display = "none";
      }
    }       
  }
}


</script>
